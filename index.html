<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>TaxSyncQC ‚Äî Estimation officielle Qu√©bec 2025</title>
    <style>
      :root {
        --bg: #f6f8fb;
        --card: #ffffff;
        --accent: #2563eb;
        --accent-2: #0ea5e9;
        --success: #0f9d58;
        --warning: #f97316;
        --text: #0f172a;
        --muted: #64748b;
        --border: #e2e8f0;
        --radius: 12px;
        --shadow: 0 10px 40px rgba(15, 23, 42, 0.08);
      }

      * {
        box-sizing: border-box;
      }

      body {
        font-family:
          'Inter',
          -apple-system,
          BlinkMacSystemFont,
          'Segoe UI',
          sans-serif;
        margin: 0;
        background:
          radial-gradient(circle at 20% 20%, rgba(37, 99, 235, 0.08), transparent 25%),
          radial-gradient(circle at 80% 0%, rgba(14, 165, 233, 0.09), transparent 30%), var(--bg);
        color: var(--text);
        line-height: 1.6;
        padding: 0 1rem 2rem;
      }

      .page {
        max-width: 1100px;
        margin: 0 auto;
        padding-top: 1.5rem;
      }

      .surface {
        background: var(--card);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border: 1px solid var(--border);
      }

      .topbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        margin-bottom: 1rem;
        position: sticky;
        top: 0;
        z-index: 100;
        background: var(--bg);
        padding: 1rem 1.5rem;
        margin-top: -1rem;
        box-shadow: 0 2px 8px rgba(15, 23, 42, 0.06);
        border-radius: 8px;
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-weight: 700;
        color: var(--text);
        letter-spacing: -0.01em;
      }

      .badge {
        padding: 0.35rem 0.75rem;
        border-radius: 999px;
        background: rgba(37, 99, 235, 0.1);
        color: var(--accent);
        font-weight: 600;
        font-size: 0.95rem;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
      }

      .hero {
        background: linear-gradient(135deg, rgba(37, 99, 235, 0.08), rgba(14, 165, 233, 0.08));
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 1.5rem;
        box-shadow: var(--shadow);
        margin-bottom: 1.25rem;
      }

      h1 {
        margin: 0 0 0.5rem;
        font-size: 1.8rem;
        letter-spacing: -0.02em;
      }
      h2 {
        margin: 0.5rem 0 0.75rem;
      }
      h3 {
        margin-top: 0;
      }

      .lang-toggle button {
        background: transparent;
        color: var(--text);
        border: 1px solid var(--border);
        padding: 0.4rem 0.75rem;
        border-radius: 999px;
        cursor: pointer;
        font-weight: 600;
        min-width: 52px;
        transition: all 0.2s ease;
      }
      .lang-toggle button:hover {
        border-color: var(--accent);
        color: var(--accent);
      }
      .lang-toggle button[style*='bold'] {
        background: var(--accent);
        color: #fff;
        border-color: var(--accent);
      }

      .tabs {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 0.5rem;
        margin: 1rem 0;
      }

      .tab-btn {
        padding: 0.9rem 1.2rem;
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        cursor: pointer;
        font-weight: 700;
        text-align: left;
        color: var(--text);
        box-shadow: var(--shadow);
        transition: all 0.2s ease;
      }
      .tab-btn:hover {
        border-color: var(--accent);
        transform: translateY(-1px);
      }
      .tab-btn.active {
        background: linear-gradient(135deg, #2563eb, #0ea5e9);
        color: #fff;
        border-color: transparent;
      }

      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }

      fieldset {
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 1rem;
        margin-bottom: 1.25rem;
        background: #fcfdff;
      }

      legend {
        font-weight: 700;
        padding: 0 0.5rem;
        color: var(--text);
      }
      .input-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 1rem 1.5rem;
      }
      .input-group {
        margin-bottom: 1rem;
      }
      label {
        display: block;
        font-weight: 700;
        margin-bottom: 0.25rem;
        color: var(--text);
      }
      .box-label {
        color: var(--accent);
        font-family: 'SFMono-Regular', Menlo, Consolas, monospace;
      }
      .hint {
        font-size: 0.9rem;
        color: var(--muted);
        margin-top: 0.25rem;
      }

      input,
      select,
      textarea {
        width: 100%;
        padding: 0.65rem 0.75rem;
        border: 1px solid var(--border, #ccc);
        border-radius: 8px;
        background: #fff;
        transition:
          border-color 0.2s ease,
          box-shadow 0.2s ease;
      }
      input:focus,
      select:focus,
      textarea:focus {
        border-color: var(--accent);
        outline: none;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
      }

      .toggle {
        margin: 1rem 0;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.6rem 0.9rem;
        background: #fff;
        border-radius: 999px;
        border: 1px solid var(--border);
        box-shadow: var(--shadow);
      }

      .btn {
        background: linear-gradient(135deg, #2563eb, #0ea5e9);
        color: #fff;
        padding: 0.85rem 1.3rem;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 700;
        letter-spacing: 0.01em;
        transition:
          transform 0.15s ease,
          box-shadow 0.15s ease;
        box-shadow: var(--shadow);
      }
      .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 10px 30px rgba(37, 99, 235, 0.25);
      }
      .btn:active {
        transform: translateY(0);
      }
      .btn.secondary {
        background: linear-gradient(135deg, #0f9d58, #10b981);
        margin-left: 0;
      }
      .btn.ghost {
        background: #fff;
        color: var(--text);
        border: 1px solid var(--border);
        box-shadow: none;
      }

      .action-row {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        align-items: center;
        margin: 1rem 0;
      }

      .result {
        background: #eef5ff;
        border: 1px solid rgba(37, 99, 235, 0.2);
        padding: 1.25rem;
        margin: 1.25rem 0;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
      }

      .warnings {
        color: var(--warning);
        margin-top: 1rem;
        font-weight: 600;
      }
      .warnings ul {
        margin: 0.35rem 0 0;
        padding-left: 1.1rem;
        color: var(--text);
      }

      .json-output {
        background: #0f172a;
        color: #e2e8f0;
        padding: 1rem;
        border-radius: var(--radius);
        overflow-x: auto;
        font-family: 'SFMono-Regular', Menlo, Consolas, monospace;
        font-size: 0.9em;
        margin-top: 1rem;
        border: 1px solid #1e293b;
      }

      .integration {
        border: 1px dashed var(--border);
        padding: 1.2rem;
        border-radius: var(--radius);
        margin: 1.25rem 0;
        background: #f8fafc;
        box-shadow: var(--shadow);
      }

      .integration h2 {
        margin-top: 0;
        display: flex;
        align-items: center;
        gap: 0.4rem;
      }
      #n8nStatus {
        min-height: 1.2rem;
        font-weight: 600;
      }

      .pill-row {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin: 0.75rem 0;
      }
      .pill {
        padding: 0.45rem 0.75rem;
        border-radius: 999px;
        background: #fff;
        border: 1px solid var(--border);
        font-size: 0.95rem;
        color: var(--muted);
        box-shadow: var(--shadow);
      }

      footer {
        margin-top: 2rem;
        color: var(--muted);
        font-size: 0.95rem;
        text-align: center;
      }
    /* Footer */
    footer{margin-top:3rem;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:2rem}
    .footer-content{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1.5rem}
    .footer-left{display:flex;flex-direction:column;gap:0.5rem}
    .footer-title{font-size:1.25rem;font-weight:700;color:var(--accent)}
    .footer-subtitle{color:var(--muted);font-size:0.9rem}
    .footer-right{display:flex;gap:1rem;align-items:center;flex-wrap:wrap}
    .footer-link{display:inline-flex;align-items:center;gap:0.5rem;padding:0.5rem 1rem;background:rgba(37,99,235,0.05);border:1px solid var(--border);border-radius:8px;color:var(--text);text-decoration:none;font-weight:600;transition:all 0.2s;font-size:0.9rem}
    .footer-link:hover{border-color:var(--accent);color:var(--accent);transform:translateY(-2px);box-shadow:0 4px 12px rgba(37,99,235,0.15)}
    .tech-badge{display:inline-block;padding:0.25rem 0.75rem;background:rgba(37,99,235,0.08);border:1px solid rgba(37,99,235,0.2);border-radius:6px;font-size:0.75rem;color:var(--accent);font-weight:600}
    @media(max-width:768px){.footer-content{flex-direction:column;text-align:center}.footer-right{justify-content:center}}
    </style>
  </head>
  <body>
    <div class="page">
      <header class="topbar">
        <div class="brand">
          <span style="font-size: 1.7rem">üí∞</span>
          <div>
            <div data-i18n="headerTitle">TaxSyncQC</div>
            <small class="hint" data-i18n="headerSubtitle">Cr√©dits Qu√©bec + F√©d√©ral 2025</small>
          </div>
        </div>
        <div class="lang-toggle">
          <button onclick="setLang('en')" id="btn-en">EN</button>
          <button onclick="setLang('fr')" id="btn-fr" style="font-weight: bold">FR</button>
        </div>
      </header>

      <main role="main">
        <div class="hero">
          <div class="badge" data-i18n="badge2025">‚úÖ Conforme 2025</div>
          <h1 data-i18n="title">üí∞ TaxSyncQC ‚Äî Estimation officielle Qu√©bec 2025</h1>
          <p data-i18n="subtitle">
            Bas√© sur les documents <strong>RL-1-T(2025-10)</strong> et <strong>T4 (2025)</strong> de
            Revenu Qu√©bec et l'ARC.
          </p>
          <div class="pill-row">
            <div class="pill">‚ö° 100% navigateur ‚Äî aucune donn√©e envoy√©e</div>
            <div class="pill">üá®üá¶ & üá∂üá® Bilingue</div>
            <div class="pill">üìä RRSP & cr√©dits majeurs</div>
          </div>
        </div>

        <div class="toggle">
          <label>
            <input type="checkbox" id="modeToggle" onchange="toggleMode()" />
            <span data-i18n="advancedMode">Mode avanc√© (tous les champs)</span>
          </label>
        </div>

        <div class="tabs">
          <button class="tab-btn active" onclick="showTab('rl1', event)" data-tab="rl1">
            RL-1 (Revenu Qu√©bec)
          </button>
          <button class="tab-btn" onclick="showTab('t4', event)" data-tab="t4">T4 (ARC)</button>
          <button class="tab-btn" onclick="showTab('both', event)" data-tab="both" data-i18n="tabBoth">Les deux</button>
        </div>

        <div class="surface">
          <!-- RL-1 Tab -->
          <div id="rl1Tab" class="tab-content active">
            <form id="rl1Form">
              <fieldset>
                <legend data-i18n="essentialRequired">‚úÖ Essentiel (requis)</legend>
                <div class="input-grid">
                  <div class="input-group">
                    <label
                      ><span class="box-label">Case A</span> ‚Äî
                      <span data-i18n="rl1BoxA">Revenu d'emploi (Ligne 101)</span></label
                    >
                    <input type="number" id="rl1_A" step="100" placeholder="Ex: 60000" />
                    <div class="hint" data-i18n="hintRL1BoxA">Box A ‚Äî top left on RL-1</div>
                  </div>
                  <div class="input-group">
                    <label
                      ><span class="box-label">Case F</span> ‚Äî
                      <span data-i18n="rl1BoxF">Cotisations syndicales (Ligne 397.1)</span></label
                    >
                    <input type="number" id="rl1_F" step="1" placeholder="Ex: 400" />
                  </div>
                  <div class="input-group">
                    <label data-i18n="sinLabel">NAS</label>
                    <input type="text" id="rl1_sin" maxlength="11" placeholder="Ex: 123 456 789" />
                  </div>
                </div>
              </fieldset>

              <fieldset id="rl1Deductions" style="display: none">
                <legend data-i18n="deductions">‚ö†Ô∏è D√©ductions</legend>
                <div class="input-grid">
                  <div class="input-group">
                    <label
                      ><span class="box-label">Case B.A</span> ‚Äî
                      <span data-i18n="rl1BoxBA">Cotisations RRQ (Ligne 98)</span></label
                    >
                    <input type="number" id="rl1_BA" step="1" />
                  </div>
                  <div class="input-group">
                    <label
                      ><span class="box-label">Case H</span> ‚Äî
                      <span data-i18n="rl1BoxH">Prime d'assurance parentale (Ligne 97)</span></label
                    >
                    <input type="number" id="rl1_H" step="1" />
                  </div>
                  <div class="input-group">
                    <label
                      ><span class="box-label">Case D</span> ‚Äî
                      <span data-i18n="rl1BoxD">Cotisations RPA (Ligne 205)</span></label
                    >
                    <input type="number" id="rl1_D" step="1" />
                  </div>
                  <div class="input-group">
                    <label
                      ><span class="box-label">Case D-1</span> ‚Äî
                      <span data-i18n="rl1BoxD1">Arrangement de retraite (Ligne 207)</span></label
                    >
                    <input type="number" id="rl1_D1" step="1" />
                  </div>
                  <div class="input-group">
                    <label
                      ><span class="box-label">Case N</span> ‚Äî
                      <span data-i18n="rl1BoxN">Dons de bienfaisance (Ligne 395)</span></label
                    >
                    <input type="number" id="rl1_N" step="1" />
                  </div>
                </div>
              </fieldset>

              <fieldset id="rl1Benefits" style="display: none">
                <legend data-i18n="taxableBenefits">
                  üîπ Avantages imposables (inclus dans la Case A)
                </legend>
                <div class="input-grid">
                  <div class="input-group">
                    <label
                      ><span class="box-label">Case J</span> ‚Äî
                      <span data-i18n="rl1BoxJ"
                        >R√©gime priv√© de soins de sant√© (Ligne 381)</span
                      ></label
                    >
                    <input type="number" id="rl1_J" step="1" />
                  </div>
                  <div class="input-group">
                    <label
                      ><span class="box-label">Case K</span> ‚Äî
                      <span data-i18n="rl1BoxK"
                        >D√©placements (r√©gion √©loign√©e) (Ligne 236)</span
                      ></label
                    >
                    <input type="number" id="rl1_K" step="1" />
                  </div>
                  <div class="input-group">
                    <label
                      ><span class="box-label">Case L</span> ‚Äî
                      <span data-i18n="rl1BoxL">Autres avantages</span></label
                    >
                    <input type="number" id="rl1_L" step="1" />
                  </div>
                  <div class="input-group">
                    <label
                      ><span class="box-label">Case M</span> ‚Äî
                      <span data-i18n="rl1BoxM">Commissions (Ligne 100)</span></label
                    >
                    <input type="number" id="rl1_M" step="1" />
                  </div>
                </div>
              </fieldset>
            </form>
          </div>

          <!-- T4 Tab -->
          <div id="t4Tab" class="tab-content">
            <form id="t4Form">
              <fieldset>
                <legend data-i18n="essentialRequired">‚úÖ Essentiel (requis)</legend>
                <div class="input-grid">
                  <div class="input-group">
                    <label
                      ><span class="box-label">Box 14</span> ‚Äî
                      <span data-i18n="t4Box14">Revenus d'emploi (Ligne 10100)</span></label
                    >
                    <input type="number" id="t4_14" step="100" placeholder="Ex: 60000" />
                    <div class="hint" data-i18n="hintT4Box14">Box 14 ‚Äî center-left on T4</div>
                  </div>
                  <div class="input-group">
                    <label
                      ><span class="box-label">Box 44</span> ‚Äî
                      <span data-i18n="t4Box44">Cotisations syndicales (Ligne 21200)</span></label
                    >
                    <input type="number" id="t4_44" step="1" placeholder="Ex: 400" />
                  </div>
                  <div class="input-group">
                    <label data-i18n="sinLabelT4">SIN</label>
                    <input type="text" id="t4_sin" maxlength="11" placeholder="Ex: 123-456-789" />
                  </div>
                </div>
              </fieldset>

              <fieldset id="t4Deductions" style="display: none">
                <legend data-i18n="deductions">‚ö†Ô∏è D√©ductions</legend>
                <div class="input-grid">
                  <div class="input-group">
                    <label
                      ><span class="box-label">Box 17</span> ‚Äî
                      <span data-i18n="t4Box17">Cotisations RRQ (QC)</span> /
                      <span class="box-label">Box 16</span> ‚Äî
                      <span data-i18n="t4Box16">RPC (autres)</span></label
                    >
                    <input type="number" id="t4_17" step="1" placeholder="QC: Box 17" />
                    <input type="number" id="t4_16" step="1" placeholder="Elsewhere: Box 16" />
                  </div>
                  <div class="input-group">
                    <label
                      ><span class="box-label">Box 55</span> ‚Äî
                      <span data-i18n="t4Box55">RPAP (QC)</span> /
                      <span class="box-label">Box 18</span> ‚Äî
                      <span data-i18n="t4Box18">AE</span></label
                    >
                    <input type="number" id="t4_55" step="1" placeholder="QC: Box 55" />
                    <input type="number" id="t4_18" step="1" placeholder="Elsewhere: Box 18" />
                  </div>
                  <div class="input-group">
                    <label
                      ><span class="box-label">Box 20</span> ‚Äî
                      <span data-i18n="t4Box20">Cotisations RPA (Ligne 20700)</span></label
                    >
                    <input type="number" id="t4_20" step="1" />
                  </div>
                  <div class="input-group">
                    <label
                      ><span class="box-label">Box 52</span> ‚Äî
                      <span data-i18n="t4Box52">Facteur d'√©quivalence (Ligne 20600)</span></label
                    >
                    <input type="number" id="t4_52" step="1" />
                  </div>
                  <div class="input-group">
                    <label
                      ><span class="box-label">Box 46</span> ‚Äî
                      <span data-i18n="t4Box46">Dons de bienfaisance</span></label
                    >
                    <input type="number" id="t4_46" step="1" />
                  </div>
                </div>
              </fieldset>

              <fieldset id="t4Benefits" style="display: none">
                <legend data-i18n="taxableBenefitsT4">
                  üîπ Avantages imposables (d√©j√† inclus dans Box 14)
                </legend>
                <div class="input-grid">
                  <div class="input-group">
                    <label
                      ><span class="box-label">Boxes 30, 32, 34, 36, 38, 40</span> ‚Äî
                      <span data-i18n="t4BoxBenefits"
                        >Avantages divers (logement, auto, pr√™ts, etc.)</span
                      ></label
                    >
                    <input type="number" id="t4_benefits" step="1" placeholder="Total si connu" />
                  </div>
                </div>
              </fieldset>
            </form>
          </div>

          <!-- Both Tab -->
          <div id="bothTab" class="tab-content">
            <p data-i18n="bothTabDesc">
              Entrez les donn√©es des deux formulaires ci-dessus ‚Äî utile pour les travailleurs en
              double statut (ex: autochtone, r√©serviste).
            </p>
          </div>

          <div class="surface">
            <div class="input-group">
              <label data-i18n="rrspContribution">Contribution RRSP ($)</label>
              <input
                type="number"
                id="rrspInput"
                step="100"
                min="0"
                max="31560"
                value="0"
                placeholder="Ex: 5000"
              />
              <div class="hint" data-i18n="hintRRSP">Maximum: $31,560 (2025 limit)</div>
            </div>
          </div>

          <div class="integration">
            <h2 data-i18n="n8nTitle">üîó Connect to n8n</h2>
            <p class="hint" data-i18n="n8nDesc">
              Send pasted email/text to an n8n webhook that extracts RL-1/T4 fields and optional
              RRSP suggestion.
            </p>
            <div class="input-group">
              <label data-i18n="n8nUrlLabel">n8n webhook URL</label>
              <input
                type="url"
                id="n8nUrl"
                placeholder="https://your-n8n.example/webhook/parse-slip"
              />
            </div>
            <div class="input-group">
              <label data-i18n="n8nTextLabel">Paste email/text to parse</label>
              <textarea
                id="n8nText"
                rows="4"
                placeholder="Paste a payroll email or PDF text here"
              ></textarea>
            </div>
            <div class="input-group" style="display: flex; align-items: center; gap: 0.5rem">
              <label for="autoParseToggle" style="margin: 0; font-weight: 700">Auto‚Äëparse</label>
              <input type="checkbox" id="autoParseToggle" />
              <small class="hint" id="autoParseHint"
                >Enable auto‚Äëparse on paste/drop (requires webhook configured)</small
              >
            </div>
            <div class="action-row">
              <button type="button" class="btn secondary" onclick="sendToN8n()" data-i18n="n8nSend">
                üöÄ Send to n8n
              </button>
              <button
                type="button"
                class="btn ghost"
                id="applyN8nBtn"
                onclick="applyN8nData()"
                disabled
                data-i18n="n8nApply"
              >
                ‚¨áÔ∏è Apply parsed fields
              </button>
            </div>
            <div id="n8nStatus" class="hint"></div>
          </div>

          <div class="action-row">
            <button
              type="button"
              class="btn"
              onclick="calculate && calculate()"
              data-i18n="estimateButton"
            >
              Estimer les cr√©dits
            </button>
            <button
              type="button"
              class="btn ghost"
              id="exportBtn"
              onclick="toggleJSON()"
              style="display: none"
              data-i18n="exportButton"
            >
              üìã Export JSON
            </button>
          </div>

          <div id="output"></div>
          <div id="jsonOutput" class="json-output" style="display: none"></div>
        </div>
      </main>

      <footer style="background:#fff;border-top:2px solid #e2e8f0;padding:2rem 0;margin-top:3rem;text-align:center">
        <div style="max-width:1200px;margin:0 auto;padding:0 1rem;color:#64748b;font-size:0.9rem">
          <div>üí∞ <strong style="color:#2563eb">TaxSyncQC</strong> ‚Äî <span data-i18n="footerBuiltBy">Construit par Ihab Saloum</span> ‚Ä¢ <span data-i18n="footerOpenSource">Projet Open Source</span></div>
          <div style="margin:0.75rem 0">
            <span style="background:rgba(37,99,235,0.08);padding:0.25rem 0.6rem;border-radius:4px;margin:0 0.25rem;font-size:0.75rem;color:#2563eb">JavaScript</span>
            <span style="background:rgba(37,99,235,0.08);padding:0.25rem 0.6rem;border-radius:4px;margin:0 0.25rem;font-size:0.75rem;color:#2563eb">HTML5</span>
            <span style="background:rgba(37,99,235,0.08);padding:0.25rem 0.6rem;border-radius:4px;margin:0 0.25rem;font-size:0.75rem;color:#2563eb">Qu√©bec Tax</span>
            <span style="background:rgba(37,99,235,0.08);padding:0.25rem 0.6rem;border-radius:4px;margin:0 0.25rem;font-size:0.75rem;color:#2563eb">Bilingue</span>
            <span style="background:rgba(37,99,235,0.08);padding:0.25rem 0.6rem;border-radius:4px;margin:0 0.25rem;font-size:0.75rem;color:#2563eb">100% Client-Side</span>
          </div>
          <div>
            <a href="https://github.com/Isaloum/TaxSyncQC" target="_blank" style="color:#2563eb;text-decoration:none;margin:0 0.5rem"><span data-i18n="footerViewSource">Voir le code source</span></a> ‚Ä¢
            <a href="https://github.com/Isaloum" target="_blank" style="color:#2563eb;text-decoration:none;margin:0 0.5rem"><span data-i18n="footerMoreProjects">Plus de projets ‚Üí</span></a>
          </div>
        </div>
      </footer>
    </div>

    <script src="tax-calculator-bundle.js"></script>
    <script src="fix-calculate-browser.js"></script>
    <script src="autoparse.js"></script>
    <script>
      let lastN8nResult = null;

      let lang = 'fr';      const translations = {
        en: {
          headerTitle: 'TaxSyncQC',
          headerSubtitle: 'Quebec + Federal Tax Credits 2025',
          title: 'üí∞ TaxSyncQC ‚Äî Official Quebec 2025 Estimator',
          subtitle:
            'Based on <strong>RL-1-T(2025-10)</strong> and <strong>T4 (2025)</strong> from Revenu Qu√©bec and CRA.',
          advancedMode: 'Advanced mode (all fields)',
          tabRL1: 'RL-1 (Revenu Qu√©bec)',
          tabT4: 'T4 (CRA)',
          tabBoth: 'Both',
          badge2025: '‚úÖ 2025 Compliant',
          essentialRequired: '‚úÖ Essential (required)',
          rl1BoxA: 'Employment income (Line 101)',
          hintRL1BoxA: 'Box A ‚Äî top left on RL-1',
          rl1BoxF: 'Union dues (Line 397.1)',
          sinLabel: 'SIN',
          sinLabelT4: 'SIN',
          deductions: '‚ö†Ô∏è Deductions',
          rl1BoxBA: 'QPP contributions (Line 98)',
          rl1BoxH: 'Parental insurance premium (Line 97)',
          rl1BoxD: 'RPP contributions (Line 205)',
          rl1BoxD1: 'Retirement arrangement (Line 207)',
          rl1BoxN: 'Charitable donations (Line 395)',
          taxableBenefits: 'üîπ Taxable benefits (included in Box A)',
          rl1BoxJ: 'Private health services plan (Line 381)',
          rl1BoxK: 'Travel (remote area) (Line 236)',
          rl1BoxL: 'Other benefits',
          rl1BoxM: 'Commissions (Line 100)',
          t4Box14: 'Employment income (Line 10100)',
          hintT4Box14: 'Box 14 ‚Äî center-left on T4',
          t4Box44: 'Union dues (Line 21200)',
          t4Box17: 'QPP contributions (QC)',
          t4Box16: 'CPP (other provinces)',
          t4Box55: 'QPIP (QC)',
          t4Box18: 'EI',
          t4Box20: 'RPP contributions (Line 20700)',
          t4Box52: 'Pension adjustment (Line 20600)',
          t4Box46: 'Charitable donations',
          taxableBenefitsT4: 'üîπ Taxable benefits (already included in Box 14)',
          t4BoxBenefits: 'Various benefits (housing, car, loans, etc.)',
          bothTabDesc:
            'Enter data from both forms above ‚Äî useful for dual-status workers (e.g., Indigenous, reservist).',
          rrspContribution: 'RRSP Contribution ($)',
          hintRRSP: 'Maximum: $31,560 (2025 limit)',
          estimateButton: 'Estimate Credits',
          exportButton: 'üìã Export JSON',
          n8nTitle: 'üîó Connect to n8n',
          n8nDesc:
            'Send pasted email/text to an n8n webhook that extracts RL-1/T4 fields and optional RRSP suggestion.',
          n8nUrlLabel: 'n8n webhook URL',
          n8nTextLabel: 'Paste email/text to parse',
          n8nSend: 'üöÄ Send to n8n',
          n8nApply: '‚¨áÔ∏è Apply parsed fields',
          n8nNoResult: 'No parsed fields yet ‚Äî send text to your webhook first.',
          n8nApplied: 'Applied parsed values to the form.',
          n8nErrorMissing: 'Please paste some text and set your n8n webhook URL.',
          n8nErrorInvalidUrl: 'Enter a valid http(s) webhook URL.',
          n8nErrorCall:
            'Could not reach the n8n webhook. Double-check the URL and response format.',
          n8nErrorPayload: 'Webhook response was missing RL-1/T4/RRSP fields.',
          resultTitle: 'üßæ Quebec + Federal Estimate (2025)',
          grossIncome: 'üíº Gross income',
          afterRRSP: 'üìâ After RRSP',
          taxSavings: 'üí∞ Tax savings',
          qcSection: 'üá∂üá® Quebec',
          solidarityCredit: 'üí∞ Solidarity credit',
          workPremium: 'üë∑ Work premium',
          fedSection: 'üá®üá¶ Federal',
          bpaSavings: 'üõ°Ô∏è BPA savings',
          cwb: 'üíµ CWB',
          totalBenefit: 'üéØ Total benefit',
          cashRefund: 'üí∏ Cash refund',
          warnings: 'üí° Tips to increase your refund:',
          warningUnionDues: 'Add union dues (Case F) ‚Äî could save $30-150 in taxes',
          footerBuiltBy: 'Built by Ihab Saloum',
          footerOpenSource: 'Open Source Project',
          footerViewSource: 'View source code',
          footerMoreProjects: 'More projects ‚Üí',
        },
        fr: {
          headerTitle: 'TaxSyncQC',
          headerSubtitle: 'Cr√©dits Qu√©bec + F√©d√©ral 2025',
          title: 'üí∞ TaxSyncQC ‚Äî Estimation officielle Qu√©bec 2025',
          subtitle:
            "Bas√© sur les documents <strong>RL-1-T(2025-10)</strong> et <strong>T4 (2025)</strong> de Revenu Qu√©bec et l'ARC.",
          advancedMode: 'Mode avanc√© (tous les champs)',
          tabRL1: 'RL-1 (Revenu Qu√©bec)',
          tabT4: 'T4 (ARC)',
          tabBoth: 'Les deux',
          badge2025: '‚úÖ Conforme 2025',
          essentialRequired: '‚úÖ Essentiel (requis)',
          rl1BoxA: "Revenu d'emploi (Ligne 101)",
          hintRL1BoxA: 'Case A ‚Äî en haut √† gauche du RL-1',
          rl1BoxF: 'Cotisations syndicales (Ligne 397.1)',
          sinLabel: 'NAS',
          sinLabelT4: 'NAS',
          deductions: '‚ö†Ô∏è D√©ductions',
          rl1BoxBA: 'Cotisations RRQ (Ligne 98)',
          rl1BoxH: "Prime d'assurance parentale (Ligne 97)",
          rl1BoxD: 'Cotisations RPA (Ligne 205)',
          rl1BoxD1: 'Arrangement de retraite (Ligne 207)',
          rl1BoxN: 'Dons de bienfaisance (Ligne 395)',
          taxableBenefits: 'üîπ Avantages imposables (inclus dans la Case A)',
          rl1BoxJ: 'R√©gime priv√© de soins de sant√© (Ligne 381)',
          rl1BoxK: 'D√©placements (r√©gion √©loign√©e) (Ligne 236)',
          rl1BoxL: 'Autres avantages',
          rl1BoxM: 'Commissions (Ligne 100)',
          t4Box14: "Revenus d'emploi (Ligne 10100)",
          hintT4Box14: 'Case 14 ‚Äî au centre gauche du T4',
          t4Box44: 'Cotisations syndicales (Ligne 21200)',
          t4Box17: 'Cotisations RRQ (QC)',
          t4Box16: 'RPC (autres provinces)',
          t4Box55: 'RPAP (QC)',
          t4Box18: 'AE',
          t4Box20: 'Cotisations RPA (Ligne 20700)',
          t4Box52: "Facteur d'√©quivalence (Ligne 20600)",
          t4Box46: 'Dons de bienfaisance',
          taxableBenefitsT4: 'üîπ Avantages imposables (d√©j√† inclus dans Case 14)',
          t4BoxBenefits: 'Avantages divers (logement, auto, pr√™ts, etc.)',
          bothTabDesc:
            'Entrez les donn√©es des deux formulaires ci-dessus ‚Äî utile pour les travailleurs en double statut (ex: autochtone, r√©serviste).',
          rrspContribution: 'Contribution RRSP ($)',
          hintRRSP: 'Maximum : 31 560 $ (limite 2025)',
          estimateButton: 'Estimer les cr√©dits',
          exportButton: 'üìã Exporter JSON',
          n8nTitle: 'üîó Se connecter √† n8n',
          n8nDesc:
            'Envoyez un courriel/texte coll√© vers un webhook n8n qui extrait les cases RL-1/T4 et une suggestion RRSP optionnelle.',
          n8nUrlLabel: 'URL du webhook n8n',
          n8nTextLabel: 'Collez le courriel/texte √† analyser',
          n8nSend: 'üöÄ Envoyer √† n8n',
          n8nApply: '‚¨áÔ∏è Appliquer les champs extraits',
          n8nNoResult:
            "Aucun champ extrait pour le moment ‚Äî envoyez d'abord le texte √† votre webhook.",
          n8nApplied: 'Valeurs extraites appliqu√©es au formulaire.',
          n8nErrorMissing: "Collez un texte et ajoutez l'URL du webhook n8n.",
          n8nErrorInvalidUrl: 'Entrez une URL de webhook http(s) valide.',
          n8nErrorCall:
            "Impossible de joindre le webhook n8n. V√©rifiez l'URL et le format de r√©ponse.",
          n8nErrorPayload: 'La r√©ponse du webhook ne contient pas de champs RL-1/T4/RRSP.',
          resultTitle: 'üßæ Estimation Qu√©bec + F√©d√©ral (2025)',
          grossIncome: 'üíº Revenu brut',
          afterRRSP: 'üìâ Apr√®s RRSP',
          taxSavings: "üí∞ √âconomie d'imp√¥t",
          qcSection: 'üá∂üá® Qu√©bec',
          solidarityCredit: 'üí∞ Cr√©dit solidarit√©',
          workPremium: 'üë∑ Prime au travail',
          fedSection: 'üá®üá¶ F√©d√©ral',
          bpaSavings: 'üõ°Ô∏è √âconomies BPA',
          cwb: 'üíµ PTE',
          totalBenefit: 'üéØ Avantage total',
          cashRefund: 'üí∏ Remboursement',
          warnings: 'üí° Conseils pour augmenter votre remboursement :',
          warningUnionDues:
            "Ajoutez vos cotisations syndicales (Case F) ‚Äî pourrait √©conomiser 30-150 $ d'imp√¥t",
          footerBuiltBy: 'Construit par Ihab Saloum',
          footerOpenSource: 'Projet Open Source',
          footerViewSource: 'Voir le code source',
          footerMoreProjects: 'Plus de projets ‚Üí',
        },
      };

      const _ = (key) => translations[lang][key] || key;

      function setLang(l) {
        lang = l;
        document.getElementById('btn-en').style.fontWeight = l === 'en' ? 'bold' : 'normal';
        document.getElementById('btn-fr').style.fontWeight = l === 'fr' ? 'bold' : 'normal';
        document.documentElement.lang = l;
        document.title = _('title').replace(/<[^>]*>/g, '');

        document.querySelectorAll('[data-i18n]').forEach((el) => {
          const key = el.getAttribute('data-i18n');
          el.innerHTML = _(key);
        });

        const n8nStatus = document.getElementById('n8nStatus');
        if (n8nStatus && n8nStatus.dataset.i18nKey) {
          n8nStatus.textContent = _(n8nStatus.dataset.i18nKey);
        }
      }

      function toggleMode() {
        const advanced = document.getElementById('modeToggle').checked;
        ['rl1Deductions', 'rl1Benefits', 't4Deductions', 't4Benefits'].forEach((id) => {
          const el = document.getElementById(id);
          if (el) el.style.display = advanced ? 'block' : 'none';
        });
        document.getElementById('exportBtn').style.display =
          advanced && lastCalculationData ? 'inline-block' : 'none';
      }

      function showTab(tabId, ev) {
        ['rl1Tab', 't4Tab', 'bothTab'].forEach((id) => {
          const el = document.getElementById(id);
          if (el) el.classList.toggle('active', id === `${tabId}Tab`);
        });
        document.querySelectorAll('.tab-btn').forEach((btn) => btn.classList.remove('active'));
        if (ev && ev.currentTarget) ev.currentTarget.classList.add('active');
        else if (ev && ev.target) ev.target.classList.add('active');
      }

      function toggleJSON() {
        const jsonDiv = document.getElementById('jsonOutput');
        if (jsonDiv.style.display === 'none') {
          jsonDiv.style.display = 'block';
          document.getElementById('exportBtn').textContent =
            '‚úñÔ∏è ' + (lang === 'fr' ? 'Fermer JSON' : 'Close JSON');
        } else {
          jsonDiv.style.display = 'none';
          document.getElementById('exportBtn').innerHTML = _('exportButton');
        }
      }

      function getFormData() {
        const isRL1 = document.getElementById('rl1Tab').classList.contains('active');

        const data = {
          source: isRL1 ? 'RL-1' : 'T4',
          rl1: { A: null, F: null, sin: null },
          t4: { 14: null, 44: null, sin: null },
        };

        if (isRL1) {
          data.rl1.A = parseFloat(document.getElementById('rl1_A').value) || 0;
          data.rl1.F = parseFloat(document.getElementById('rl1_F').value) || null;
          data.rl1.sin = document.getElementById('rl1_sin').value;
          if (document.getElementById('modeToggle').checked) {
            data.rl1['B.A'] = parseFloat(document.getElementById('rl1_BA').value) || null;
            data.rl1.H = parseFloat(document.getElementById('rl1_H').value) || null;
            data.rl1.D = parseFloat(document.getElementById('rl1_D').value) || null;
            data.rl1['D-1'] = parseFloat(document.getElementById('rl1_D1').value) || null;
            data.rl1.N = parseFloat(document.getElementById('rl1_N').value) || null;
            data.rl1.J = parseFloat(document.getElementById('rl1_J').value) || null;
            data.rl1.K = parseFloat(document.getElementById('rl1_K').value) || null;
            data.rl1.L = parseFloat(document.getElementById('rl1_L').value) || null;
            data.rl1.M = parseFloat(document.getElementById('rl1_M').value) || null;
          }
        } else {
          data.t4['14'] = parseFloat(document.getElementById('t4_14').value) || 0;
          data.t4['44'] = parseFloat(document.getElementById('t4_44').value) || null;
          data.t4.sin = document.getElementById('t4_sin').value;
          if (document.getElementById('modeToggle').checked) {
            data.t4['17'] = parseFloat(document.getElementById('t4_17').value) || null;
            data.t4['16'] = parseFloat(document.getElementById('t4_16').value) || null;
            data.t4['55'] = parseFloat(document.getElementById('t4_55').value) || null;
            data.t4['18'] = parseFloat(document.getElementById('t4_18').value) || null;
            data.t4['20'] = parseFloat(document.getElementById('t4_20').value) || null;
            data.t4['52'] = parseFloat(document.getElementById('t4_52').value) || null;
            data.t4['46'] = parseFloat(document.getElementById('t4_46').value) || null;
            data.t4.benefits = parseFloat(document.getElementById('t4_benefits').value) || null;
          }
        }

        return data;
      }

      function setN8nStatus(key, fallbackText = '') {
        const statusEl = document.getElementById('n8nStatus');
        if (!statusEl) return;
        if (key) {
          statusEl.dataset.i18nKey = key;
          statusEl.textContent = _(key);
        } else {
          statusEl.dataset.i18nKey = '';
          statusEl.textContent = fallbackText;
        }
      }

      function isValidWebhookUrl(url) {
        try {
          const parsed = new URL(url);
          return ['http:', 'https:'].includes(parsed.protocol);
        } catch (e) {
          return false;
        }
      }

      function sanitizeSlipFields(raw) {
        if (!raw || typeof raw !== 'object') return {};
        const clean = {};
        Object.entries(raw).forEach(([key, value]) => {
          const normalizedKey = key.toString().replace(/[^a-zA-Z0-9]/g, '');
          const num =
            typeof value === 'string' ? parseFloat(value.replace(/[, ]+/g, '')) : Number(value);
          if (normalizedKey && Number.isFinite(num)) {
            clean[normalizedKey] = num;
          }
        });
        return clean;
      }

      function normalizeN8nPayload(payload) {
        if (!payload || typeof payload !== 'object') {
          return null;
        }

        if (!payload.rl1 && !payload.t4 && payload.data && typeof payload.data === 'object') {
          payload = payload.data;
        }

        const rl1 = sanitizeSlipFields(payload.rl1);
        const t4 = sanitizeSlipFields(payload.t4);
        const rrspRaw = payload.rrsp;
        const hasContent =
          (rl1 && Object.keys(rl1).length > 0) ||
          (t4 && Object.keys(t4).length > 0) ||
          (rrspRaw !== undefined && rrspRaw !== null);
        if (!hasContent) {
          return null;
        }

        const rrsp = rrspRaw === undefined || rrspRaw === null ? null : Number(rrspRaw);
        return {
          rl1,
          t4,
          rrsp: Number.isFinite(rrsp) ? rrsp : null,
        };
      }

      function loadSavedN8nUrl() {
        try {
          const saved = localStorage.getItem('n8nWebhookUrl');
          if (saved) {
            document.getElementById('n8nUrl').value = saved;
          }
        } catch (e) {
          // ignore
        }
      }

      async function sendToN8n() {
        const url = document.getElementById('n8nUrl').value.trim();
        const text = document.getElementById('n8nText').value.trim();
        const applyBtn = document.getElementById('applyN8nBtn');
        applyBtn.disabled = true;
        lastN8nResult = null;

        if (!url || !text) {
          setN8nStatus('n8nErrorMissing');
          return;
        }

        if (!isValidWebhookUrl(url)) {
          setN8nStatus('n8nErrorInvalidUrl');
          return;
        }

        setN8nStatus(null, lang === 'fr' ? 'Envoi au webhook n8n‚Ä¶' : 'Sending to n8n webhook‚Ä¶');

        try {
          try {
            localStorage.setItem('n8nWebhookUrl', url);
          } catch (e) {
            /* ignore */
          }

          const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text, lang, source: 'taxsyncqc-web' }),
          });

          if (!response.ok) throw new Error('Bad status');

          const payload = await response.json();
          const normalized = normalizeN8nPayload(payload);
          if (!normalized) {
            setN8nStatus('n8nErrorPayload');
            return;
          }

          lastN8nResult = normalized;
          applyBtn.disabled = false;

          const summary = [];
          if (normalized.rl1 && Object.keys(normalized.rl1).length > 0)
            summary.push(`RL-1: ${Object.keys(normalized.rl1).join(', ')}`);
          if (normalized.t4 && Object.keys(normalized.t4).length > 0)
            summary.push(`T4: ${Object.keys(normalized.t4).join(', ')}`);
          if (normalized.rrsp !== undefined && normalized.rrsp !== null)
            summary.push(`RRSP: ${normalized.rrsp}`);

          const statusText =
            (lang === 'fr' ? 'Champs re√ßus: ' : 'Fields received: ') +
            (summary.join(' | ') || 'OK');
          setN8nStatus(null, statusText);
        } catch (err) {
          setN8nStatus('n8nErrorCall');
        }
      }

      function applyN8nData() {
        const applyBtn = document.getElementById('applyN8nBtn');
        if (!lastN8nResult) {
          setN8nStatus('n8nNoResult');
          applyBtn.disabled = true;
          return;
        }

        const applied = [];
        const applyFields = (prefix, data) => {
          if (!data) return;
          Object.entries(data).forEach(([key, value]) => {
            const normalizedKey = key.toString().replace(/[^a-zA-Z0-9]/g, '');
            const el = document.getElementById(`${prefix}_${normalizedKey}`);
            if (el && value !== undefined && value !== null && value !== '') {
              el.value = value;
              applied.push(`${prefix.toUpperCase()} ${key}`);
            }
          });
        };

        applyFields('rl1', lastN8nResult.rl1);
        applyFields('t4', lastN8nResult.t4);

        if (lastN8nResult.rrsp !== undefined && lastN8nResult.rrsp !== null) {
          document.getElementById('rrspInput').value = lastN8nResult.rrsp;
          applied.push('RRSP');
        }

        if (applied.length === 0) {
          setN8nStatus('n8nNoResult');
          applyBtn.disabled = true;
          return;
        }

        const statusText = `${_('n8nApplied')} (${applied.join(', ')})`;
        setN8nStatus(null, statusText);
        if (calculate) {
          calculate();
        }
      }

      // Initialize calculate function
      let calculate;
      if (typeof window.initFixCalculate === 'function' && typeof window.TaxCalculator === 'object') {
        calculate = window.initFixCalculate(window.TaxCalculator, _);
        window.calculate = calculate;
        console.log('[TaxSyncQC] Calculate function ready!');
      } else {
        console.error('[TaxSyncQC] Missing dependencies:', {
          initFixCalculate: typeof window.initFixCalculate,
          TaxCalculator: typeof window.TaxCalculator
        });
      }

      loadSavedN8nUrl();
      setN8nStatus('n8nNoResult');
      setLang('fr');
    </script>
  </body>
</html>
