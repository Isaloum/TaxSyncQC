<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TaxSyncQC ‚Äî Estimation officielle Qu√©bec 2025</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; max-width: 800px; margin: 1rem auto; padding: 0 1rem; line-height: 1.5; }
    .lang-toggle { text-align: right; margin-bottom: 1rem; }
    .tabs { display: flex; margin-bottom: 1rem; border-bottom: 1px solid #ccc; }
    .tab-btn { padding: 0.75rem 1.5rem; background: #f0f0f0; border: none; cursor: pointer; }
    .tab-btn.active { background: #1890ff; color: white; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    fieldset { border: 1px solid #ddd; border-radius: 6px; padding: 1rem; margin-bottom: 1.5rem; }
    legend { font-weight: bold; padding: 0 0.5rem; }
    .input-group { margin-bottom: 1rem; }
    label { display: block; font-weight: bold; margin-bottom: 0.25rem; }
    .box-label { color: #1890ff; font-family: monospace; }
    .hint { font-size: 0.85rem; color: #666; margin-top: 0.25rem; }
    input, select { width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; }
    .toggle { margin: 1rem 0; }
    button { background: #1890ff; color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 4px; cursor: pointer; font-size: 1.1em; }
    .result { background: #e6f7ff; border-left: 4px solid #1890ff; padding: 1rem; margin: 1.5rem 0; border-radius: 4px; }
    .warnings { color: #fa8c16; margin-top: 1rem; }
    .json-output { background: #f5f5f5; padding: 1rem; border-radius: 4px; overflow-x: auto; font-family: monospace; font-size: 0.9em; }
  </style>
</head>
<body>
  <div class="lang-toggle">
    <button onclick="setLang('en')" id="btn-en">EN</button>
    <button onclick="setLang('fr')" id="btn-fr" style="font-weight:bold">FR</button>
  </div>

  <h1>üí∞ TaxSyncQC ‚Äî Estimation officielle Qu√©bec 2025</h1>
  <p>Bas√© sur les documents <strong>RL-1-T(2025-10)</strong> et <strong>T4 (2025)</strong> de Revenu Qu√©bec et l‚ÄôARC.</p>

  <div class="toggle">
    <label>
      <input type="checkbox" id="modeToggle" onchange="toggleMode()">
      Mode avanc√© (tous les champs)
    </label>
  </div>

  <div class="tabs">
    <button class="tab-btn active" onclick="showTab('rl1')">RL-1 (Revenu Qu√©bec)</button>
    <button class="tab-btn" onclick="showTab('t4')">T4 (ARC)</button>
    <button class="tab-btn" onclick="showTab('both')">Les deux</button>
  </div>

  <!-- RL-1 Tab -->
  <div id="rl1Tab" class="tab-content active">
    <form id="rl1Form">
      <fieldset>
        <legend>‚úÖ Essentiel (requis)</legend>
        <div class="input-group">
          <label><span class="box-label">Case A</span> ‚Äî Revenu d‚Äôemploi (Ligne <strong>101</strong>)</label>
          <input type="number" id="rl1_A" step="100" placeholder="Ex: 60000">
          <div class="hint">Box A ‚Äî top left on RL-1</div>
        </div>
        <div class="input-group">
          <label><span class="box-label">Case F</span> ‚Äî Cotisations syndicales (Ligne <strong>397.1</strong>)</label>
          <input type="number" id="rl1_F" step="1" placeholder="Ex: 400">
        </div>
        <div class="input-group">
          <label>NAS</label>
          <input type="text" id="rl1_sin" maxlength="11" placeholder="Ex: 123 456 789">
        </div>
      </fieldset>

      <fieldset id="rl1Deductions" style="display:none;">
        <legend>‚ö†Ô∏è D√©ductions</legend>
        <div class="input-group">
          <label><span class="box-label">Case B.A</span> ‚Äî Cotisations RRQ (Ligne <strong>98</strong>)</label>
          <input type="number" id="rl1_BA" step="1">
        </div>
        <div class="input-group">
          <label><span class="box-label">Case H</span> ‚Äî Prime d‚Äôassurance parentale (Ligne <strong>97</strong>)</label>
          <input type="number" id="rl1_H" step="1">
        </div>
        <div class="input-group">
          <label><span class="box-label">Case D</span> ‚Äî Cotisations RPA (Ligne <strong>205</strong>)</label>
          <input type="number" id="rl1_D" step="1">
        </div>
        <div class="input-group">
          <label><span class="box-label">Case D-1</span> ‚Äî Arrangement de retraite (Ligne <strong>207</strong>)</label>
          <input type="number" id="rl1_D1" step="1">
        </div>
        <div class="input-group">
          <label><span class="box-label">Case N</span> ‚Äî Dons de bienfaisance (Ligne <strong>395</strong>)</label>
          <input type="number" id="rl1_N" step="1">
        </div>
      </fieldset>

      <fieldset id="rl1Benefits" style="display:none;">
        <legend>üîπ Avantages imposables (inclus dans la Case A)</legend>
        <div class="input-group">
          <label><span class="box-label">Case J</span> ‚Äî R√©gime priv√© de soins de sant√© (Ligne <strong>381</strong>)</label>
          <input type="number" id="rl1_J" step="1">
        </div>
        <div class="input-group">
          <label><span class="box-label">Case K</span> ‚Äî D√©placements (r√©gion √©loign√©e) (Ligne <strong>236</strong>)</label>
          <input type="number" id="rl1_K" step="1">
        </div>
        <div class="input-group">
          <label><span class="box-label">Case L</span> ‚Äî Autres avantages</label>
          <input type="number" id="rl1_L" step="1">
        </div>
        <div class="input-group">
          <label><span class="box-label">Case M</span> ‚Äî Commissions (Ligne <strong>100</strong>)</label>
          <input type="number" id="rl1_M" step="1">
        </div>
      </fieldset>
    </form>
  </div>

  <!-- T4 Tab -->
  <div id="t4Tab" class="tab-content">
    <form id="t4Form">
      <fieldset>
        <legend>‚úÖ Essentiel (requis)</legend>
        <div class="input-group">
          <label><span class="box-label">Box 14</span> ‚Äî Revenus d‚Äôemploi (Ligne <strong>10100</strong>)</label>
          <input type="number" id="t4_14" step="100" placeholder="Ex: 60000">
          <div class="hint">Box 14 ‚Äî center-left on T4</div>
        </div>
        <div class="input-group">
          <label><span class="box-label">Box 44</span> ‚Äî Cotisations syndicales (Ligne <strong>21200</strong>)</label>
          <input type="number" id="t4_44" step="1" placeholder="Ex: 400">
        </div>
        <div class="input-group">
          <label>SIN</label>
          <input type="text" id="t4_sin" maxlength="11" placeholder="Ex: 123-456-789">
        </div>
      </fieldset>

      <fieldset id="t4Deductions" style="display:none;">
        <legend>‚ö†Ô∏è D√©ductions</legend>
        <div class="input-group">
          <label><span class="box-label">Box 17</span> ‚Äî Cotisations RRQ (QC) / <span class="box-label">Box 16</span> ‚Äî RPC (autres)</label>
          <input type="number" id="t4_17" step="1" placeholder="QC: Box 17">
          <input type="number" id="t4_16" step="1" placeholder="Elsewhere: Box 16">
        </div>
        <div class="input-group">
          <label><span class="box-label">Box 55</span> ‚Äî RPAP (QC) / <span class="box-label">Box 18</span> ‚Äî AE</label>
          <input type="number" id="t4_55" step="1" placeholder="QC: Box 55">
          <input type="number" id="t4_18" step="1" placeholder="Elsewhere: Box 18">
        </div>
        <div class="input-group">
          <label><span class="box-label">Box 20</span> ‚Äî Cotisations RPA (Ligne <strong>20700</strong>)</label>
          <input type="number" id="t4_20" step="1">
        </div>
        <div class="input-group">
          <label><span class="box-label">Box 52</span> ‚Äî Facteur d‚Äô√©quivalence (Ligne <strong>20600</strong>)</label>
          <input type="number" id="t4_52" step="1">
        </div>
        <div class="input-group">
          <label><span class="box-label">Box 46</span> ‚Äî Dons de bienfaisance</label>
          <input type="number" id="t4_46" step="1">
        </div>
      </fieldset>

      <fieldset id="t4Benefits" style="display:none;">
        <legend>üîπ Avantages imposables (d√©j√† inclus dans Box 14)</legend>
        <div class="input-group">
          <label><span class="box-label">Boxes 30, 32, 34, 36, 38, 40</span> ‚Äî Avantages divers (logement, auto, pr√™ts, etc.)</label>
          <input type="number" id="t4_benefits" step="1" placeholder="Total si connu">
        </div>
      </fieldset>
    </form>
  </div>

  <!-- Both Tab -->
  <div id="bothTab" class="tab-content">
    <p>Entrez les donn√©es des deux formulaires ci-dessus ‚Äî utile pour les travailleurs en double statut (ex: autochtone, r√©serviste).</p>
  </div>

  <div class="input-group">
    <label>Contribution RRSP ($)</label>
    <input type="range" id="rrspSlider" min="0" max="31560" value="0" step="100" oninput="updateRrsp(this.value)">
    <div id="rrspValue">$0</div>
  </div>

  <button type="button" onclick="calculate()">Estimer les cr√©dits</button>

  <div id="output"></div>
  <div id="jsonOutput" class="json-output" style="display:none;"></div>

  <script>
    let lang = 'fr';
    const translations = {
      en: { title: "TaxSyncQC ‚Äî Official Quebec 2025 Estimator", subtitle: "Based on RL-1 & T4 slips", estimate: "Estimate Credits", result: "üßæ Quebec + Federal Estimate (2025)" },
      fr: { title: "TaxSyncQC ‚Äî Estimation officielle Qu√©bec 2025", subtitle: "Bas√© sur les formulaires RL-1 et T4", estimate: "Estimer les cr√©dits", result: "üßæ Estimation Qu√©bec + F√©d√©ral (2025)" }
    };
    const _ = (key) => translations[lang][key] || key;

    function setLang(l) {
      lang = l;
      document.getElementById('btn-en').style.fontWeight = l === 'en' ? 'bold' : 'normal';
      document.getElementById('btn-fr').style.fontWeight = l === 'fr' ? 'bold' : 'normal';
      document.title = _( 'title' );
      document.querySelector('h1').textContent = _( 'title' );
      document.querySelector('button').textContent = _( 'estimate' );
    }

    function toggleMode() {
      const advanced = document.getElementById('modeToggle').checked;
      ['rl1Deductions', 'rl1Benefits', 't4Deductions', 't4Benefits'].forEach(id => {
        document.getElementById(id).style.display = advanced ? 'block' : 'none';
      });
      document.getElementById('jsonOutput').style.display = advanced ? 'block' : 'none';
    }

    function showTab(tabId) {
      ['rl1Tab', 't4Tab', 'bothTab'].forEach(id => {
        document.getElementById(id).classList.toggle('active', id === tabId + 'Tab');
      });
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
    }

    function updateRrsp(val) {
      document.getElementById('rrspValue').textContent = `$${parseInt(val).toLocaleString()}`;
    }

    function getFormData() {
      const isRL1 = document.getElementById('rl1Tab').classList.contains('active');
      const form = isRL1 ? 'rl1' : 't4';
      
      const data = {
        source: isRL1 ? 'RL-1' : 'T4',
        rl1: { A: null, F: null, sin: null },
        t4: { '14': null, '44': null, sin: null }
      };

      if (isRL1) {
        data.rl1.A = parseFloat(document.getElementById('rl1_A').value) || 0;
        data.rl1.F = parseFloat(document.getElementById('rl1_F').value) || null;
        data.rl1.sin = document.getElementById('rl1_sin').value;
        if (document.getElementById('modeToggle').checked) {
          data.rl1['B.A'] = parseFloat(document.getElementById('rl1_BA').value) || null;
          data.rl1.H = parseFloat(document.getElementById('rl1_H').value) || null;
          data.rl1.D = parseFloat(document.getElementById('rl1_D').value) || null;
          data.rl1['D-1'] = parseFloat(document.getElementById('rl1_D1').value) || null;
          data.rl1.N = parseFloat(document.getElementById('rl1_N').value) || null;
          data.rl1.J = parseFloat(document.getElementById('rl1_J').value) || null;
          data.rl1.K = parseFloat(document.getElementById('rl1_K').value) || null;
          data.rl1.L = parseFloat(document.getElementById('rl1_L').value) || null;
          data.rl1.M = parseFloat(document.getElementById('rl1_M').value) || null;
        }
      } else {
        data.t4['14'] = parseFloat(document.getElementById('t4_14').value) || 0;
        data.t4['44'] = parseFloat(document.getElementById('t4_44').value) || null;
        data.t4.sin = document.getElementById('t4_sin').value;
        if (document.getElementById('modeToggle').checked) {
          data.t4['17'] = parseFloat(document.getElementById('t4_17').value) || null;
          data.t4['16'] = parseFloat(document.getElementById('t4_16').value) || null;
          data.t4['55'] = parseFloat(document.getElementById('t4_55').value) || null;
          data.t4['18'] = parseFloat(document.getElementById('t4_18').value) || null;
          data.t4['20'] = parseFloat(document.getElementById('t4_20').value) || null;
          data.t4['52'] = parseFloat(document.getElementById('t4_52').value) || null;
          data.t4['46'] = parseFloat(document.getElementById('t4_46').value) || null;
          data.t4.benefits = parseFloat(document.getElementById('t4_benefits').value) || null;
        }
      }

      return data;
    }

    function calculate() {
      const data = getFormData();
      const income = data.source === 'RL-1' ? data.rl1.A : data.t4['14'];
      const unionDues = data.source === 'RL-1' ? data.rl1.F : data.t4['44'];
      const sin = data.source === 'RL-1' ? data.rl1.sin : data.t4.sin;
      const rrsp = parseFloat(document.getElementById('rrspSlider').value) || 0;
      const effectiveIncome = Math.max(0, income - rrsp);

      // Qu√©bec credits
      const solidarity = effectiveIncome <= 57965 ? 531 : Math.max(0, 531 * (1 - (effectiveIncome - 57965) / 6160));
      const workPremium = effectiveIncome < 7200 ? 0 : Math.min(728, Math.min(effectiveIncome - 7200, 33100) * 0.26);

      // Federal credits
      const cwb = effectiveIncome <= 25539 ? Math.min(effectiveIncome * 0.27, 1519) : 
                 effectiveIncome <= 35539 ? Math.max(0, 1519 - (effectiveIncome - 25539) * 0.15) : 0;
      const bpa = Math.max(0, 15705 - Math.max(0, effectiveIncome - 165430) * 15705 / 70000);
      const bpaSavings = bpa * 0.15;

      // RRSP tax saved
      const marginalRate = income <= 51268 ? 0.2885 : income <= 57965 ? 0.3325 : 0.3885;
      const taxSaved = rrsp * marginalRate;

      const qcTotal = solidarity + workPremium;
      const fedTotal = bpaSavings + cwb;
      const totalBenefit = qcTotal + fedTotal + taxSaved;
      const cashBack = workPremium + cwb;

      let html = `<div class="result">
        <h3>${_( 'result' )}</h3>
        <p><strong>üíº Revenu brut: $${income.toLocaleString()}</strong></p>
        ${rrsp > 0 ? `<p>üìâ Apr√®s RRSP ($${rrsp.toLocaleString()}): $${effectiveIncome.toLocaleString()}</p>` : ''}
        ${rrsp > 0 ? `<p>üí∞ √âconomie d'imp√¥t: $${taxSaved.toFixed(2)}</p>` : ''}
        <h4>üá∂üá® Qu√©bec</h4>
        <p>üí∞ Cr√©dit solidarit√©: $${solidarity.toFixed(2)}</p>
        <p>üë∑ Prime au travail: $${workPremium.toFixed(2)}</p>
        <h4>üá®üá¶ F√©d√©ral</h4>
        <p>üõ°Ô∏è √âconomies BPA: $${bpaSavings.toFixed(2)}</p>
        <p>üíµ PTE: $${cwb.toFixed(2)}</p>
        <hr>
        <p><strong>üéØ Avantage total: $${totalBenefit.toFixed(2)}</strong></p>
        <p style="font-size: 1.2em; color: #1890ff;"><strong>üí∏ Remboursement: $${cashBack.toFixed(2)}</strong></p>
      </div>`;

      const warnings = [];
      if (unionDues === null) warnings.push("Cotisations syndicales manquantes ‚Äî peuvent √™tre d√©ductibles");
      if (!sin || !/\d{9}/.test(sin.replace(/\D/g, ''))) warnings.push("NAS manquant ‚Äî obligatoire");
      if (warnings.length > 0) {
        html += `<div class="warnings"><strong>‚ö†Ô∏è Avertissements :</strong><ul>`;
        warnings.forEach(w => html += `<li>${w}</li>`);
        html += '</ul></div>';
      }

      document.getElementById('output').innerHTML = html;

      // Show structured JSON for automation
      if (document.getElementById('modeToggle').checked) {
        const exportData = {
          ...data,
          analysis: {
            effectiveIncome,
            qcCredits: { solidarity, workPremium },
            fedCredits: { bpaSavings, cwb },
            rrspImpact: { contribution: rrsp, taxSaved }
          }
        };
        document.getElementById('jsonOutput').textContent = JSON.stringify(exportData, null, 2);
      }
    }

    // Init
    setLang('fr');
  </script>
</body>
</html>
