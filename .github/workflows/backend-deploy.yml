name: Backend Deployment

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - '.github/workflows/backend-deploy.yml'
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy Backend to AWS Lambda
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Setup AWS SAM CLI
        uses: aws-actions/setup-sam@v2
        with:
          use-installer: true

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Verify AWS credentials
        run: |
          echo "âœ… Verifying AWS credentials..."
          aws sts get-caller-identity
          echo "âœ… AWS credentials verified!"

      - name: Install backend dependencies
        run: |
          cd backend
          npm ci

      - name: Build TypeScript backend
        run: |
          cd backend
          echo "ðŸ”¨ Building TypeScript..."
          npm run build
          echo "âœ… TypeScript build complete!"

      - name: Build SAM application
        run: |
          cd backend
          echo "ðŸ“¦ Building SAM application..."
          sam build
          echo "âœ… SAM build complete!"

      - name: Deploy to AWS Lambda
        id: deploy
        run: |
          cd backend
          echo "ðŸš€ Deploying to AWS Lambda..."
          sam deploy \
            --no-confirm-changeset \
            --no-fail-on-empty-changeset \
            --stack-name taxflowai-backend \
            --capabilities CAPABILITY_IAM \
            --parameter-overrides \
              DatabaseUrl="${{ secrets.DATABASE_URL }}" \
              SupabaseUrl="${{ secrets.SUPABASE_URL }}" \
              SupabaseServiceKey="${{ secrets.SUPABASE_SERVICE_KEY }}" \
              OpenAIKey="${{ secrets.OPENAI_API_KEY }}" \
              AllowedOrigin="'https://main.d2gxcp91k7yq8u.amplifyapp.com'"
          echo "âœ… Deployment complete!"

      - name: Get API endpoint
        id: endpoint
        run: |
          cd backend
          API_ENDPOINT=$(sam list stack-outputs --stack-name taxflowai-backend --output json | jq -r '.[] | select(.OutputKey=="ApiEndpoint") | .OutputValue')
          echo "API_ENDPOINT=$API_ENDPOINT" >> $GITHUB_OUTPUT
          echo "ðŸŒ API Endpoint: $API_ENDPOINT"

      - name: Test API endpoints
        id: test
        run: |
          cd backend
          chmod +x scripts/test-deployment.sh
          ./scripts/test-deployment.sh ${{ steps.endpoint.outputs.API_ENDPOINT }}
        continue-on-error: true

      - name: Post deployment status to PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const apiEndpoint = '${{ steps.endpoint.outputs.API_ENDPOINT }}';
            const testStatus = '${{ steps.test.outcome }}';
            const testIcon = testStatus === 'success' ? 'âœ…' : 'âš ï¸';
            
            const comment = `## ðŸš€ Backend Deployment Status
            
            **Deployment:** âœ… Successful
            **API Endpoint:** \`${apiEndpoint}\`
            **Tests:** ${testIcon} ${testStatus === 'success' ? 'Passed' : 'Failed (check logs)'}
            
            ### Deployed Functions
            - âœ… AuthFunction
            - âœ… DocumentFunction
            - âœ… UserFunction
            - âœ… NotificationFunction
            
            ### Next Steps
            1. Update frontend \`NEXT_PUBLIC_API_URL\` with the API endpoint
            2. Test authentication endpoints
            3. Verify CORS configuration
            
            ---
            _Deployment completed at ${new Date().toISOString()}_`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Summary
        run: |
          echo "## ðŸŽ‰ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Status:** Deployment successful" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ **API Endpoint:** ${{ steps.endpoint.outputs.API_ENDPOINT }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ§ª **Tests:** ${{ steps.test.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployed Resources" >> $GITHUB_STEP_SUMMARY
          echo "- AWS Lambda Functions (4)" >> $GITHUB_STEP_SUMMARY
          echo "- API Gateway REST API" >> $GITHUB_STEP_SUMMARY
          echo "- CloudWatch Log Groups" >> $GITHUB_STEP_SUMMARY
          echo "- IAM Roles and Policies" >> $GITHUB_STEP_SUMMARY
